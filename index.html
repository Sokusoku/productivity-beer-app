<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Speed Reader Pro</title>
    <style>
        :root {
            --bg-color: #000000;
            --text-silver: #c0c0c0;
            --text-red: #ff0000;
            --ui-bg: #1a1a1a;
            --ui-border: #333;
            --accent: #444;
            --active-btn: #333;
            
            /* Dynamic Settings */
            --reader-font: 'Courier New', Courier, monospace;
            --reader-size: 4rem; 
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-silver);
            font-family: var(--reader-font);
            margin: 0;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
        }

        /* --- UTILS --- */
        .hidden { display: none !important; }
        .btn-icon { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-silver); padding: 5px; transition: color 0.2s; }
        .btn-icon:hover { color: #fff; }

        /* --- SCROLLABLE LAYOUT --- */
        .scroll-container {
            height: 100%;
            width: 100%;
            overflow-y: auto;
            padding: 20px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* --- PAGE 1: HOME --- */
        #page-home { width: 100%; height: 100%; }

        .home-header {
            width: 100%;
            max-width: 600px;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            margin-bottom: 20px;
        }

        .home-header h1 { margin: 0; font-weight: normal; letter-spacing: 2px; }
        .logo-red { color: var(--text-red); font-weight: bold; }
        
        .gear-icon {
            position: absolute;
            right: 0;
            font-size: 1.5rem;
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
        }
        .gear-icon:hover { color: #fff; transform: rotate(90deg); transition: transform 0.3s; }

        .home-content {
            width: 100%;
            max-width: 600px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            padding-bottom: 40px;
        }

        .section-title {
            font-size: 1.1rem;
            color: #fff;
            border-bottom: 1px solid var(--text-red);
            padding-bottom: 5px;
            margin-top: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .card {
            background-color: var(--ui-bg);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid var(--ui-border);
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .subsection-label {
            font-size: 0.85rem;
            color: #888;
            margin-bottom: -5px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
        }

        select {
            width: 100%;
            padding: 12px;
            background: #222;
            color: #fff;
            border: 1px solid #444;
            border-radius: 6px;
            font-size: 1rem;
            box-sizing: border-box;
            font-family: inherit;
        }

        /* Options Grid */
        .options-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            background: #111;
            padding: 4px;
            border-radius: 8px;
            border: 1px solid #333;
        }

        .option-btn {
            background: transparent;
            border: none;
            color: #888;
            padding: 8px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
        }

        .option-btn:hover { color: #fff; }
        
        .option-btn.selected {
            background: var(--text-red);
            color: white;
            font-weight: bold;
        }

        .summary-box {
            background: #111;
            border: 1px solid #333;
            padding: 12px;
            border-radius: 6px;
            color: #ccc;
            font-size: 0.9rem;
            line-height: 1.4;
            min-height: 60px;
        }

        button.primary-btn {
            background: var(--text-red);
            color: white;
            border: none;
            padding: 15px;
            font-size: 1.2rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: transform 0.1s;
            margin-top: 10px;
        }
        button.primary-btn:active { transform: scale(0.98); }

        /* --- PAGE 2: READER (IMMERSIVE) --- */
        #page-reader {
            display: flex;
            flex-direction: column;
            height: 100%;
            width: 100%;
            position: relative;
        }

        .reader-top-bar {
            display: flex;
            justify-content: space-between;
            padding: 20px;
            position: absolute;
            top: 0; left: 0; right: 0;
            z-index: 10;
        }

        .reader-main {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .word-display {
            display: flex;
            width: 100%;
            font-size: var(--reader-size); 
            font-weight: bold;
            line-height: 1;
            user-select: none;
            transition: font-size 0.2s;
        }
        
        .segment { white-space: pre; font-family: var(--reader-font); }
        .segment.left { flex: 1; text-align: right; color: var(--text-silver); }
        .segment.pivot { color: var(--text-red); width: 0.8ch; text-align: center; display: inline-block; }
        .segment.right { flex: 1; text-align: left; color: var(--text-silver); }

        .guide-notch-top, .guide-notch-bottom {
            position: absolute; left: 50%; width: 2px; height: 15px; background-color: #333; transform: translateX(-50%);
        }
        .guide-notch-top { top: 20%; }
        .guide-notch-bottom { bottom: 20%; }

        .reader-footer {
            padding: 40px 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            background: linear-gradient(to top, rgba(0,0,0,1) 30%, rgba(0,0,0,0));
        }

        .progress-text { color: #666; font-size: 0.85rem; letter-spacing: 1px; margin-bottom: 5px; }

        .control-panel {
            display: flex;
            align-items: center;
            gap: 25px;
            background: rgba(26, 26, 26, 0.8);
            padding: 10px 30px;
            border-radius: 50px;
            border: 1px solid #333;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
        }

        .btn-circle {
            width: 45px; height: 45px; border-radius: 50%; border: 1px solid #444;
            background: transparent; color: var(--text-silver); font-size: 1.2rem; cursor: pointer;
            display: flex; align-items: center; justify-content: center; transition: all 0.2s ease;
        }
        .btn-circle:hover { background: #333; color: white; transform: scale(1.05); }
        .btn-circle.play { width: 55px; height: 55px; border-color: var(--text-red); color: white; font-size: 1.4rem; }
        .btn-circle.play:hover { background: rgba(255, 0, 0, 0.1); box-shadow: 0 0 15px rgba(255, 0, 0, 0.2); }
        .speed-text { color: var(--text-red); font-size: 0.9rem; font-weight: bold; margin-top: 5px; }

        /* --- PAGE 3: SETTINGS --- */
        #page-settings {
            background: #000;
            width: 100%; height: 100%;
            display: flex;
            flex-direction: column;
            padding: 20px;
            box-sizing: border-box;
        }

        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #333;
            padding-bottom: 15px;
            margin-bottom: 20px;
        }
        .settings-header h2 { margin: 0; color: #fff; }

        .settings-content {
            flex: 1;
            overflow-y: auto;
            max-width: 600px;
            margin: 0 auto;
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        .setting-group {
            background: var(--ui-bg);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #333;
        }
        .setting-label { display: block; color: #aaa; margin-bottom: 10px; font-weight: bold; }

        .preview-box {
            background: #000;
            border: 1px solid #444;
            height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            margin-bottom: 10px;
            border-radius: 4px;
            overflow: hidden;
        }
        .preview-box .word-display { font-size: 2rem; } 

        .sound-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            border-bottom: 1px solid #222;
            padding-bottom: 5px;
        }
        .sound-row select { width: 150px; padding: 5px; font-size: 0.9rem; }
        .sound-label { color: #ccc; font-size: 0.9rem; }

        .settings-footer {
            margin-top: 20px;
            display: flex;
            justify-content: space-between;
            border-top: 1px solid #333;
            padding-top: 20px;
            max-width: 600px;
            margin-left: auto; margin-right: auto; width: 100%;
        }

        .btn-secondary { background: #333; color: #ccc; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; }
        .btn-secondary:hover { background: #444; color: #fff; }
        .btn-save { background: var(--text-red); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .btn-save:hover { background: #d00000; }

        input[type=range] { width: 100%; cursor: pointer; accent-color: var(--text-red); }

    </style>
</head>
<body>

    <!-- === PAGE 1: HOME === -->
    <div id="page-home">
        <div class="scroll-container">
            <div class="home-header">
                <h1>Speed<span class="logo-red">R</span>eader</h1>
                <button id="btnOpenSettings" class="gear-icon" title="Settings">‚öôÔ∏è</button>
            </div>

            <div class="home-content">
                
                <div class="section-title">Library</div>
                <div class="card">
                    <div class="subsection-label">Select Story</div>
                    <select id="storySelect">
                        <option value="" disabled selected>Loading Library...</option>
                    </select>

                    <div class="subsection-label">
                        <span>Tone Variant</span>
                    </div>
                    <div class="options-grid" id="toneSelector">
                        <button class="option-btn" data-val="spicier">Spicier üå∂Ô∏è</button>
                        <button class="option-btn selected" data-val="happy">Happy üôÇ</button>
                        <button class="option-btn" data-val="sad">Sad üò¢</button>
                    </div>

                    <div class="subsection-label">
                        <span>Length Version</span>
                    </div>
                    <div class="options-grid" id="lengthSelector">
                        <button class="option-btn selected" data-val="short">Short (500)</button>
                        <button class="option-btn" data-val="medium">Medium (1k)</button>
                        <button class="option-btn" data-val="long">Long (5k)</button>
                    </div>

                    <div class="subsection-label">
                        <span>Summary</span>
                        <span id="wordCountDisplay" style="color: var(--text-red);">Words: 0</span>
                    </div>
                    <div id="staticSummary" class="summary-box">
                        Select a story to view summary.
                    </div>
                </div>

                <button id="btnStartReading" class="primary-btn">Start Reading</button>
            </div>
        </div>
    </div>

    <!-- === PAGE 2: READER === -->
    <div id="page-reader" class="hidden">
        <div class="reader-top-bar">
            <button id="btnCloseReader" class="btn-icon" title="Back to Home">‚úï</button>
            <button id="btnSoundToggle" class="btn-icon" title="Toggle Sound">üîä</button>
        </div>

        <div class="reader-main">
            <div class="guide-notch-top"></div>
            <div class="word-display" id="readerDisplay">
                <span class="segment left" id="txtLeft">Ready</span>
                <span class="segment pivot" id="txtPivot">?</span>
                <span class="segment right" id="txtRight"></span>
            </div>
            <div class="guide-notch-bottom"></div>
        </div>

        <div class="reader-footer">
            <div class="progress-text" id="progressDisplay">0 / 0</div>
            <div class="control-panel">
                <button id="btnSlower" class="btn-circle" title="Slower (‚àí25 WPM)">‚àí</button>
                <button id="btnRewind" class="btn-circle" title="Reset">‚èÆ</button>
                <button id="btnPlayPause" class="btn-circle play" title="Play/Pause">‚ñ∂</button>
                <button id="btnFaster" class="btn-circle" title="Faster (+25 WPM)">+</button>
            </div>
            <div class="speed-text" id="wpmDisplay">300 WPM</div>
        </div>
    </div>

    <!-- === PAGE 3: SETTINGS === -->
    <div id="page-settings" class="hidden">
        <div class="settings-header">
            <h2>Settings</h2>
            <button id="btnCloseSettingsX" class="btn-icon">‚úï</button>
        </div>
        
        <div class="settings-content">
            <div class="setting-group">
                <label class="setting-label">Font & Size</label>
                <select id="setFontFamily" style="margin-bottom: 10px;">
                    <option value="'Courier New', Courier, monospace">Courier New (Default)</option>
                    <option value="Arial, sans-serif">Arial</option>
                    <option value="'Times New Roman', Times, serif">Times New Roman</option>
                    <option value="Verdana, sans-serif">Verdana</option>
                    <option value="Georgia, serif">Georgia</option>
                </select>
                
                <div style="display:flex; gap:10px; align-items:center;">
                    <span style="color:#888;">Size:</span>
                    <input type="range" id="setFontSize" min="2" max="6" step="0.5" value="4">
                    <span id="fontSizeDisplay" style="color:#fff; width:40px;">4rem</span>
                </div>
            </div>

            <div class="setting-group">
                <label class="setting-label">Live Preview</label>
                <div class="preview-box">
                    <div class="guide-notch-top" style="height:5px; top:10px;"></div>
                    <div class="word-display" id="previewDisplay">
                        <span class="segment left" id="pLeft"></span>
                        <span class="segment pivot" id="pPivot"></span>
                        <span class="segment right" id="pRight"></span>
                    </div>
                    <div class="guide-notch-bottom" style="height:5px; bottom:10px;"></div>
                </div>
                <div style="font-size:0.8rem; color:#666; text-align:center;">Updates automatically</div>
            </div>

            <div class="setting-group">
                <label class="setting-label">Sound Mapping</label>
                <div class="sound-row">
                    <span class="sound-label">Comma ( , )</span>
                    <select class="sound-select" data-punc="comma">
                        <option value="sine">Beep (Sine)</option>
                        <option value="triangle">Chime (Triangle)</option>
                        <option value="sawtooth">Buzz (Sawtooth)</option>
                        <option value="noise">Click (Noise)</option>
                    </select>
                </div>
                <div class="sound-row">
                    <span class="sound-label">Period ( . )</span>
                    <select class="sound-select" data-punc="period">
                        <option value="sawtooth" selected>Buzz (Sawtooth)</option>
                        <option value="sine">Beep (Sine)</option>
                        <option value="square">8-bit (Square)</option>
                        <option value="noise">Click (Noise)</option>
                    </select>
                </div>
                <div class="sound-row">
                    <span class="sound-label">Exclamation ( ! )</span>
                    <select class="sound-select" data-punc="exclamation">
                        <option value="noise" selected>Whoosh (Noise)</option>
                        <option value="square">Alarm (Square)</option>
                        <option value="triangle">Ding (Triangle)</option>
                    </select>
                </div>
                <div class="sound-row">
                    <span class="sound-label">Question ( ? )</span>
                    <select class="sound-select" data-punc="question">
                        <option value="triangle" selected>Bling (Triangle)</option>
                        <option value="sine">Beep (Sine)</option>
                        <option value="slide">Slide Up</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="settings-footer">
            <button id="btnResetSettings" class="btn-secondary">Reset Defaults</button>
            <button id="btnSaveSettings" class="btn-save">Save Changes</button>
        </div>
    </div>

<script>
    // --- 1. DATA SIMULATION (The "Txt Sources") ---
    // In a real app, 'content' would be loaded via fetch(). 
    // Here we generate it to satisfy the requirements without a 5MB file.
    
    const baseStories = [
        { id: 1, title: "The Last Watchmaker" },
        { id: 2, title: "Ocean of Stars" },
        { id: 3, title: "The Coffee Shop" },
        { id: 4, title: "Digital Ghost" },
        { id: 5, title: "The Whispering Forest" },
        { id: 6, title: "Gravity Racing" },
        { id: 7, title: "The Painter of Dreams" },
        { id: 8, title: "Binary Love" },
        { id: 9, title: "The Library of Lost Things" },
        { id: 10, title: "Silence on Mars" }
    ];

    // Helper to generate text based on Variant & Length
    function generateContent(title, tone, length) {
        let base = "";
        
        // 1. TONE VARIANT (Base Text)
        if (tone === 'spicier') {
            base = `(Spicier Edition of ${title}) The air crackled with tension. It wasn't just about the mission anymore; it was about the burning desire that lingered between them. Every glance was a spark, every word a challenge. The stakes were high, but the thrill was higher. Danger didn't just lurk in the shadows; it danced with them in the pale moonlight, seductive and lethal. `;
        } else if (tone === 'sad') {
            base = `(Melancholy Edition of ${title}) A heavy silence hung over the world. It was the kind of silence that drowned out hope. Memories of better days were merely ghosts now, haunting the corridors of the mind. Tears had long since dried, leaving only a hollow ache where the heart used to be. The ending wasn't tragic; it was simply inevitable, a slow fade into the gray nothingness of forgotten time. `;
        } else {
            // Happy
            base = `(Joyful Edition of ${title}) The sun broke through the clouds, casting a golden glow over everything. Laughter echoed through the air, pure and contagious. It was a day for miracles, big and small. Even the impossible seemed within reach. Friends gathered, smiles were shared, and for the first time in a long time, the future looked not just bright, but dazzling. `;
        }

        // 2. LENGTH VERSION (Extension)
        // Short: ~250-500 words. Medium: ~1000. Long: ~5000.
        // We will repeat the paragraph to match word count for simulation.
        let targetWords = 250;
        if (length === 'medium') targetWords = 1000;
        if (length === 'long') targetWords = 5000;

        let result = base;
        while (result.split(' ').length < targetWords) {
            result += " " + base;
        }
        
        // Add specific ending
        result += ` [End of ${length} version].`;
        return result;
    }

    function getSummary(title) {
        return `This is a summary of "${title}". It explores themes relevant to the selected tone, providing a quick overview before you dive into the full text.`;
    }

    // --- STATE ---
    let currentStoryId = 1;
    let currentTone = 'happy';
    let currentLength = 'short';
    
    let wordQueue = [];
    let currentIndex = 0;
    let isPlaying = false;
    let wpm = 300;
    let timer = null;
    let soundEnabled = true;

    // Default Settings
    let appSettings = {
        fontFamily: "'Courier New', Courier, monospace",
        fontSize: "4",
        sounds: { comma: 'sine', period: 'sawtooth', exclamation: 'noise', question: 'triangle' }
    };
    let tempSettings = { ...appSettings };

    // --- ELEMENTS ---
    const els = {
        pageHome: document.getElementById('page-home'),
        pageReader: document.getElementById('page-reader'),
        pageSettings: document.getElementById('page-settings'),
        
        // Home Inputs
        select: document.getElementById('storySelect'),
        toneBtns: document.querySelectorAll('#toneSelector .option-btn'),
        lengthBtns: document.querySelectorAll('#lengthSelector .option-btn'),
        staticSummary: document.getElementById('staticSummary'),
        wordCount: document.getElementById('wordCountDisplay'),
        btnStart: document.getElementById('btnStartReading'),
        
        // Settings / Nav
        btnOpenSettings: document.getElementById('btnOpenSettings'),
        btnCloseSettingsX: document.getElementById('btnCloseSettingsX'),
        btnSaveSettings: document.getElementById('btnSaveSettings'),
        btnResetSettings: document.getElementById('btnResetSettings'),

        // Reader
        left: document.getElementById('txtLeft'),
        pivot: document.getElementById('txtPivot'),
        right: document.getElementById('txtRight'),
        wpmDisplay: document.getElementById('wpmDisplay'),
        progress: document.getElementById('progressDisplay'),
        btnPlay: document.getElementById('btnPlayPause'),
        btnReset: document.getElementById('btnRewind'),
        btnFaster: document.getElementById('btnFaster'),
        btnSlower: document.getElementById('btnSlower'),
        btnClose: document.getElementById('btnCloseReader'),
        btnSound: document.getElementById('btnSoundToggle'),
        
        // Settings Inputs
        setFontFamily: document.getElementById('setFontFamily'),
        setFontSize: document.getElementById('setFontSize'),
        fontSizeDisplay: document.getElementById('fontSizeDisplay'),
        soundSelects: document.querySelectorAll('.sound-select'),
        
        // Preview
        pLeft: document.getElementById('pLeft'),
        pPivot: document.getElementById('pPivot'),
        pRight: document.getElementById('pRight'),
        readerDisplay: document.getElementById('readerDisplay'),
        previewDisplay: document.getElementById('previewDisplay')
    };

    // --- INITIALIZATION ---
    function init() {
        populateSelect();
        
        // Event Listeners
        els.select.addEventListener('change', (e) => {
            currentStoryId = parseInt(e.target.value);
            refreshHomeData();
        });

        // Tone Selection
        els.toneBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                // Update UI
                els.toneBtns.forEach(b => b.classList.remove('selected'));
                btn.classList.add('selected');
                // Update State
                currentTone = btn.dataset.val;
                refreshHomeData();
            });
        });

        // Length Selection
        els.lengthBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                // Update UI
                els.lengthBtns.forEach(b => b.classList.remove('selected'));
                btn.classList.add('selected');
                // Update State
                currentLength = btn.dataset.val;
                refreshHomeData();
            });
        });

        // Navigation
        els.btnStart.addEventListener('click', openReader);
        els.btnClose.addEventListener('click', closeReader);
        els.btnOpenSettings.addEventListener('click', openSettings);
        els.btnCloseSettingsX.addEventListener('click', closeSettingsNoSave);
        els.btnSaveSettings.addEventListener('click', saveSettings);
        els.btnResetSettings.addEventListener('click', resetSettings);

        // Reader
        els.btnPlay.addEventListener('click', togglePlay);
        els.btnReset.addEventListener('click', resetReader);
        els.btnSound.addEventListener('click', toggleSound);
        els.btnFaster.addEventListener('click', () => changeSpeed(25));
        els.btnSlower.addEventListener('click', () => changeSpeed(-25));

        // Settings Live
        els.setFontFamily.addEventListener('change', updatePreviewState);
        els.setFontSize.addEventListener('input', (e) => {
            els.fontSizeDisplay.textContent = e.target.value + "rem";
            updatePreviewState();
        });
        els.soundSelects.forEach(s => s.addEventListener('change', updateSoundState));

        // Initial Load
        els.select.value = "1";
        refreshHomeData();
    }

    function populateSelect() {
        els.select.innerHTML = '';
        baseStories.forEach(s => {
            const opt = document.createElement('option');
            opt.value = s.id;
            opt.textContent = s.title;
            els.select.appendChild(opt);
        });
    }

    function refreshHomeData() {
        // 1. Find Story Title
        const story = baseStories.find(s => s.id === currentStoryId);
        if(!story) return;

        // 2. Generate/Load Text
        const fullText = generateContent(story.title, currentTone, currentLength);
        
        // 3. Update Word Count
        const wordCount = fullText.split(/\s+/).filter(w => w.length > 0).length;
        els.wordCount.textContent = `Words: ${wordCount}`;

        // 4. Update Summary
        els.staticSummary.textContent = getSummary(story.title);

        // 5. Prep Reader Queue (Invisible but ready)
        wordQueue = fullText.split(/\s+/).filter(w => w.length > 0);
    }


    // --- NAVIGATION ---
    function openReader() {
        if (wordQueue.length === 0) refreshHomeData();
        currentIndex = 0;
        updateDisplay();
        els.pageHome.classList.add('hidden');
        els.pageReader.classList.remove('hidden');
    }

    function closeReader() {
        stop();
        els.pageReader.classList.add('hidden');
        els.pageHome.classList.remove('hidden');
    }

    function openSettings() {
        tempSettings = JSON.parse(JSON.stringify(appSettings));
        
        els.setFontFamily.value = tempSettings.fontFamily;
        els.setFontSize.value = tempSettings.fontSize;
        els.fontSizeDisplay.textContent = tempSettings.fontSize + "rem";
        
        els.soundSelects.forEach(sel => {
            const punc = sel.dataset.punc;
            sel.value = tempSettings.sounds[punc];
        });

        startPreviewLoop();
        els.pageHome.classList.add('hidden');
        els.pageSettings.classList.remove('hidden');
    }

    function closeSettingsNoSave() {
        stopPreviewLoop();
        els.pageSettings.classList.add('hidden');
        els.pageHome.classList.remove('hidden');
    }

    function saveSettings() {
        appSettings = JSON.parse(JSON.stringify(tempSettings));
        document.documentElement.style.setProperty('--reader-font', appSettings.fontFamily);
        document.documentElement.style.setProperty('--reader-size', appSettings.fontSize + 'rem');
        stopPreviewLoop();
        els.pageSettings.classList.add('hidden');
        els.pageHome.classList.remove('hidden');
    }

    function resetSettings() {
        tempSettings = {
            fontFamily: "'Courier New', Courier, monospace",
            fontSize: "4",
            sounds: { comma: 'sine', period: 'sawtooth', exclamation: 'noise', question: 'triangle' }
        };
        els.setFontFamily.value = tempSettings.fontFamily;
        els.setFontSize.value = tempSettings.fontSize;
        els.fontSizeDisplay.textContent = "4rem";
        els.soundSelects.forEach(sel => {
             if(sel.dataset.punc === 'comma') sel.value = 'sine';
             if(sel.dataset.punc === 'period') sel.value = 'sawtooth';
             if(sel.dataset.punc === 'exclamation') sel.value = 'noise';
             if(sel.dataset.punc === 'question') sel.value = 'triangle';
        });
        updatePreviewState();
    }

    function updatePreviewState() {
        tempSettings.fontFamily = els.setFontFamily.value;
        tempSettings.fontSize = els.setFontSize.value;
        els.previewDisplay.style.fontFamily = tempSettings.fontFamily;
        els.previewDisplay.style.fontSize = tempSettings.fontSize + "rem";
    }

    function updateSoundState(e) {
        const punc = e.target.dataset.punc;
        tempSettings.sounds[punc] = e.target.value;
    }

    // --- PREVIEW LOOP ---
    let previewInterval = null;
    const previewWords = "A quick fox jumped over".split(" ");
    let previewIndex = 0;

    function startPreviewLoop() {
        if (previewInterval) clearInterval(previewInterval);
        els.previewDisplay.style.fontFamily = tempSettings.fontFamily;
        els.previewDisplay.style.fontSize = tempSettings.fontSize + "rem";
        previewIndex = 0;
        const tick = () => {
            const word = previewWords[previewIndex];
            const match = word.match(/^([^\w]*)([\w\-'‚Äô]+)([^\w]*)$/);
            let prefix = "", core = word, suffix = "";
            if (match) { prefix = match[1]; core = match[2]; suffix = match[3]; }
            const pivotIdx = getPivotIndex(core);
            els.pLeft.textContent = prefix + core.substring(0, pivotIdx);
            els.pPivot.textContent = core.charAt(pivotIdx);
            els.pRight.textContent = core.substring(pivotIdx + 1) + suffix;
            previewIndex = (previewIndex + 1) % previewWords.length;
        };
        tick(); 
        previewInterval = setInterval(tick, 400); 
    }

    function stopPreviewLoop() { clearInterval(previewInterval); }


    // --- AUDIO ENGINE ---
    const AudioEngine = (() => {
        let ctx = null;
        function initCtx() {
            if (!ctx) ctx = new (window.AudioContext || window.webkitAudioContext)();
            if (ctx.state === 'suspended') ctx.resume();
        }

        function playWave(type, freq, duration, slide) {
            if (!ctx) initCtx();
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            if (type === 'slide') {
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(400, ctx.currentTime);
                osc.frequency.linearRampToValueAtTime(800, ctx.currentTime + duration);
            } else {
                osc.type = type;
                osc.frequency.setValueAtTime(freq, ctx.currentTime);
            }
            gain.gain.setValueAtTime(0.1, ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + duration);
            osc.connect(gain);
            gain.connect(ctx.destination);
            osc.start();
            osc.stop(ctx.currentTime + duration);
        }

        function playNoise(duration) {
            if (!ctx) initCtx();
            const bSize = ctx.sampleRate * duration;
            const buf = ctx.createBuffer(1, bSize, ctx.sampleRate);
            const data = buf.getChannelData(0);
            for(let i=0; i<bSize; i++) data[i] = Math.random()*2-1;
            const noise = ctx.createBufferSource();
            noise.buffer = buf;
            const gain = ctx.createGain();
            gain.gain.setValueAtTime(0.15, ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime+duration);
            noise.connect(gain);
            gain.connect(ctx.destination);
            noise.start();
        }

        return {
            trigger: (puncType) => {
                const soundType = appSettings.sounds[puncType]; 
                if (soundType === 'noise') {
                    playNoise(0.2);
                } else {
                    let freq = 440;
                    if (puncType === 'period') freq = 100;
                    if (puncType === 'question') freq = 800;
                    if (puncType === 'exclamation') freq = 200;
                    playWave(soundType, freq, 0.2, soundType === 'slide');
                }
            },
            init: initCtx
        };
    })();

    // --- READER LOGIC ---
    function getPivotIndex(cleanWord) {
        const len = cleanWord.length;
        if (len === 1) return 0;
        if (len >= 2 && len <= 5) return 1;
        if (len >= 6 && len <= 9) return 2;
        if (len >= 10 && len <= 13) return 3;
        return 4;
    }

    function renderWord(rawWord) {
        if (soundEnabled && isPlaying) {
            const lastChar = rawWord.slice(-1);
            if (lastChar === ',') AudioEngine.trigger('comma');
            else if (lastChar === '.') AudioEngine.trigger('period');
            else if (lastChar === '!') AudioEngine.trigger('exclamation');
            else if (lastChar === '?') AudioEngine.trigger('question');
        }

        const match = rawWord.match(/^([^\w]*)([\w\-'‚Äô]+)([^\w]*)$/);
        let prefix = "", core = rawWord, suffix = "";
        if (match) { prefix = match[1]; core = match[2]; suffix = match[3]; }

        const pivotIdx = getPivotIndex(core);
        els.left.textContent = prefix + core.substring(0, pivotIdx);
        els.pivot.textContent = core.charAt(pivotIdx);
        els.right.textContent = core.substring(pivotIdx + 1) + suffix;
    }

    function updateDisplay() {
        els.progress.textContent = `${currentIndex} / ${wordQueue.length}`;
        if (currentIndex < wordQueue.length) {
            renderWord(wordQueue[currentIndex]);
        } else {
            stop();
            els.left.textContent = "";
            els.pivot.textContent = "DONE";
            els.right.textContent = "";
        }
    }

    function togglePlay() { isPlaying ? stop() : start(); }
    function start() {
        if (currentIndex >= wordQueue.length) currentIndex = 0;
        isPlaying = true;
        els.btnPlay.textContent = "‚è∏";
        if (soundEnabled) AudioEngine.init();
        runTimer();
    }
    function runTimer() {
        const msPerWord = 60000 / wpm;
        if (timer) clearTimeout(timer);
        timer = setTimeout(() => {
            if (!isPlaying) return;
            currentIndex++;
            if (currentIndex >= wordQueue.length) { updateDisplay(); stop(); }
            else { updateDisplay(); runTimer(); }
        }, msPerWord);
    }
    function stop() { isPlaying = false; els.btnPlay.textContent = "‚ñ∂"; if(timer) clearTimeout(timer); }
    function resetReader() { stop(); currentIndex = 0; updateDisplay(); }
    function changeSpeed(delta) {
        wpm += delta; if(wpm < 50) wpm=50; if(wpm>2000) wpm=2000;
        els.wpmDisplay.textContent = `${wpm} WPM`;
        if(isPlaying) { clearTimeout(timer); runTimer(); }
    }
    function toggleSound() {
        soundEnabled = !soundEnabled;
        els.btnSound.textContent = soundEnabled ? 'üîä' : 'üîá';
        if (soundEnabled) AudioEngine.init();
    }

    init();

</script>
</body>
</html>
